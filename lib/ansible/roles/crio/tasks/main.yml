---

# NEED TO FIX THIS TO WORK WITH DEV AND PROD
- name: Prep install CRI-O
  args:
    executable: /bin/bash
  shell: |
    curl -fsSL https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/{{OS_VERSION}}/Release.key | gpg --dearmor -o /usr/share/keyrings/libcontainers-archive-keyring.gpg
    curl -fsSL https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable:/cri-o:/{{CRIO_VERSION}}/{{OS_VERSION}}/Release.key | sudo gpg --dearmor -o /usr/share/keyrings/libcontainers-crio-archive-keyring.gpg
    echo "deb [signed-by=/usr/share/keyrings/libcontainers-archive-keyring.gpg] https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/{{OS_VERSION}}/ /" | sudo tee /etc/apt/sources.list.d/devel:kubic:libcontainers:stable.list
    echo "deb [signed-by=/usr/share/keyrings/libcontainers-crio-archive-keyring.gpg] https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable:/cri-o:/{{CRIO_VERSION}}/{{OS_VERSION}}/ /" | sudo tee /etc/apt/sources.list.d/devel:kubic:libcontainers:stable:cri-o:{{CRIO_VERSION}}.list
    
    cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
    overlay
    br_netfilter
    EOF

    sudo modprobe overlay
    sudo modprobe br_netfilter

    # Set up required sysctl params, these persist across reboots.
    cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
    net.bridge.bridge-nf-call-iptables  = 1
    net.ipv4.ip_forward                 = 1
    net.bridge.bridge-nf-call-ip6tables = 1
    EOF

    sudo sysctl --system




- name: Install Crio
  apt:
    update_cache: true
    state: latest
    name: '{{ item }}'
  loop:
    - cri-o
    - cri-o-runc
    - containernetworking-plugins
    - cri-tools

# - name: Enable IPv4 forward
#   ansible.builtin.replace:
#     path: /etc/sysctl.conf
#     regexp: '#net.ipv4.ip_forward = 1'
#     replace: 'net.ipv4.ip_forward = 1'

- name: Restart Crio
  service: name=crio state=restarted

- name: Clean apt cache
  command:
    cmd: apt clean
